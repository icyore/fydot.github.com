5月11号和5月12号终于愉快而又顺利的过去了，也算是对得起之前的努力了，首先还是交带
一下最近发生的一些事情，以及下一段时间的一些安排，然后再总体谈一下准备的过程和注
意事项

在接到电话回来准备赛务的时候，应该是4月十号的时候，那个时候刚刚结束了我至今为止最
开心的一次旅行，和某人。在回家的前天夜晚，接到了波波和梁懿的电话，说按照计划，我
需要负责整个系统这块的事情，于是回家整理了一下情绪，就回到学校了，开始了家下来比
较爽的一段时间。

下面进入正题，整理一下这次的准备准备过程，以及遇到的很多问题和响应的处理方法，作为
下次比赛的一个参考资料吧。

首先，当我回到南京的时候，aseaday已经将还原卡的问题，很漂亮的解决掉了，就是通过修改
ubuntu installer上的代码，解决了因为还原卡地址偏移，造成系统无法正常安装的问题，在
波波和机房老师的协助下，已经可以做到，通过母机将机房机器安装完成。所以，最后到我手上
的时候，我想了一下，主要就是母机系统的配置，服务器系统的配置，服务器资源的分配，以及
网络环境的搭建和测通，故障时处理方案的搭建，完整系统的负载压力测试及评估，还有指标监
控的实现，接下来，我们就一个一个开始说明吧。

* 母机系统的配置，其实是整个过程中我感觉到最费体力的事情了，因为牵一发则动全身，每次发
  现一点点问题，在修改完问题后，全部六个机房的机器全部都要重新同传，我说一下配置过程吧。
  首先，为了使得pc2客户端以及选手能够编写java代码，我们配置了jdk，openjdk，但是后来朱建伟
  说openjdk有很多问题，应该使用oracle jdk，在实际使用过程中，也遇到了openjdk带来的一些
  UI显示上的坑，但是考虑到系统的稳定性，当时就没有修改，还使用的openjdk，下次可以考虑
  使用oracel jdk。配置完成jdk以后，我们就配置了gcc/g++，这个没有太大问题（在此感谢C标准
  组织为我做的贡献），安装了eclipse，netbeans，codeblocks等编译器；vim/gvim，gedit，emacs
  等编辑器；chrome，firefox等浏览器；并且将代码打印，以及board的地址，做成快捷方式，放置在
  桌面上，方便选手。这些都是体力活，没有什么难度，然后，我们纠结了很长时间的如何禁用系统的
  u盘，最后在我么伟大的c哥的努力下，通过修改两个系统文件，完成了这个任务，具体禁止U盘的
  脚本，以及相关修改，可以查看我备份的数据

* 服务器的配置，我们有四台服务器，我们将其中的两台安装了ubuntu 12.04 LTS发行版，另外
  的两台安装了windows server 2012。每台机器的配置过程如下：
  Server A:
    主服务器，ubuntu 12.04发行版操作系统，主要运行了pc2服务器，为此我们在前期配置的时
    候，就是安装了jdk，安装的包是default jdk的包
  Server B:
    Server A的冷备服务器，软件配置环境和Server A想同，同时这个服务器还是时间服务器，为了
    在比赛过程中，确保选手的时间和服务器时间一致，防止误导选手，这个时间服务器主要是由c哥
    搭建的，撒花撒花
  Server C:
    打印程序服务器，board服务器，web备份方案服务器。安装了Windows Server 2012
  Server D:
    Server C的热备份机器，主要是热备Server C上的mysql数据库数据的，但是实际上由于时间
    问题，没有搭建好，所以处于闲置状态

* 服务器资源的分配，在最开始的时候，实际上我是没有考虑到的，因为我想只有这几个系统，这么
  点人，不会出现混乱的，可是，模拟比赛的第一天，就出现了意见极为乌龙的事件，我们的pc2服务器，
  和我们的打印程序的服务器，两台不同的机器，竟然不约而同的使用了同一个IP地址，导致地址
  冲突，恶心的ubuntu又不提醒，结果中间尴尬了好久，所以我们才对机器资源做了一个详尽的分配表，
  如下：
    账户密码表格
      选手机器、裁判机器：
        普通用户  acm             njust1104acm
        管理员    acmroot         hddacm0502sjb
      ServerA：
        管理员    njustacmserver  server
      ServerB:
        管理员    njustserver     server
      ServerC:
        管理员    administrator   njust$1219$acm
      ServerD:
        管理员    administrator   njust$1219$acm

    内网IP段分配
      172.16.0.X
        172.16.0.1  ServerA  PC^2服务器
        172.16.0.2  ServerB  PC^2服务器冷备份
        172.16.0.3  ServerC  打印服务器、Board服务器、Web服务器
        172.16.0.4  ServerD  打印服务器、Board服务器、Web服务器冷备份
      172.16.X.Y
        X机房Y座位的IP  (Y指座位前面玻璃上的号码)

    外网IP段分配
      219.230.123.166  ServerA        PC^2服务器
      219.230.123.178  ServerB        PC^2服务器冷备份
      219.230.123.160  ServerC        打印服务器、Board服务器、Web服务器
      219.230.123.172  ServerD        打印服务器、Board服务器、Web服务器冷备份
      219.230.123.xxx(134 + 座位号)   判题节点
      219.230.123.xxx(4 + 座位号)     打印机

    端口占用
      PC^2服务器:             50002 (serverA/serverB)
      SSHD服务器:             10086 (serverA/serverB)
      Printer服务器:          10086 (serverC/serverD)
      Board服务器(Tomcat):    8080  (serverC/serverD)
      Web服务器(IIS):         80    (serverC/serverD)
      Judge网站:              31415，27182，14142
  比赛中的每天早晨，我都会对这张表上的一些变化内容进行修改，然后打印发放给包括裁判在内的所有
  工作人员，保证大家对我们系统资源的分配情况是清楚的，在访问一些资源的时候，不必要去询问我们
  系统工作人员，也同时保证大家在配置过程中，不至于和原有的资源分配造成冲突。同时选手机器的IP
  绑定也是这次的一个很大的工程，最后是通过人肉统计每台机器的mac地址，手工分配IP，c哥写了一个
  修改网络配置文件的一个脚本，还是搞定了，但是这个方案的成本有点高，下次得想想有没有更爽的方
  案，毕竟生活质量是很重要的呀

* 网络环境的搭载，应该是这次比赛里面比较复杂，但是我们操心最少的一个部分了，因为有锐捷徐工的
  帮助，帮助我们实现了选手机器之间的vlan网络隔离，实现了网段的划分，保证了裁判机器，选手机器，
  服务器之间互不影响的网络环境，这次的网络方案很是成熟，下次可以完全参考这次的做法，由于我对
  网络方面基本一窍不通，所以这块就没法写的很详细了，我太水了

* 此次为了应对服务器故障，我设计了一个冷备方案，就是通过rsync，按照1分钟的时间间隔，将主服务器
  上的pc2目录，同步到我们的冷备机器上，在主服务器出现故障的时候，可以手动将主服务器的IP地址绑定
  到冷备服务器上，完成切换，当然这个方案不是最完美的，但是是我觉得最简单，而且考虑到下次比赛主要
  由学弟们负责搭建系统，所以这个方案也是学习成本最低的，所以最终我选择了这个方案。
  当然还有一个很完美的热备方案，因为pc2这个恶心的系统，逻辑和存储主要依赖于本地文件系统，所以很难
  做到不丢失状态的负载均衡，所以呢，文件系统方面还是只能依赖与rsync同步了，但是如何将冷备方案变成
  热备呢，我们可以设置一个虚拟IP，初始绑定在ServerA上，通过keepalived，在ServerA访问出现异常的时候
  动态切换到Server B，在排除了A故障以后，假设B故障了，还可以被动态切换回来，这样就做到了双机互备，
  爽歪歪了，毕竟靠人去识别机器有没有挂，挂了手动去切换，太原始了，降低生活质量啊，亲

* 关于指标的监控，这次主要监控的是网络流量方面的，aseaday学弟搭建了一个ntop系统，可以帮助我们通过
  一个还算能看的介面，观测到当前服务器的某块网卡上的所有流量信息，还是很强大的，这个系统可以按照端口
  统计信息，按照IP统计信息，按照协议类型统计信息，协议类型貌似支持从网络层到应用层的大部分协议了

关于工作内容的说明就到这里了，大家都很辛苦，特别是同传机器的时候，需要每个机房，每个机房的操作，让人
太纠结了，所以感谢波波同学在我不在的时候，将部分我的工作扛了下来，感谢强大的aseaday学弟提出的很多解
决方案（不过，孩子啊，以后改什么之前，先告诉我一下吧，嘿嘿），感谢黄c的ip脚本和时间同步方案，感谢学弟
包括但不限于桑旭，达一，嘉炎等做出的脑力和体力上的努力，顺便感谢一下机房老师和网络中心老师，包括徐工
的帮助（徐工很风趣啊，我喜欢）。但是我不喜欢机房那个老女人，张主任，我的观点是，你可以不配合但是不要
摆出一种我们欠你钱似的姿态，要么痛痛快快给，要么痛痛快快不给，我们组织比赛也是惯着南京理工大学的名号，
得不到什么个人好处的，有些钱还得教练自己掏腰包
